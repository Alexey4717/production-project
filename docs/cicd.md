Старый скрипт main.yml

<pre>
name: linting, testing, building
on:
    push:
        branches: [ master ]
    pull_request:
        branches: [ master ]
jobs:
    pipeline:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                node-version: [ 18.x ]

        steps:
            - uses: actions/checkout@v2
            - name: Staring Node.js ${{ matrix.node-version }}
                uses: actions/setup-node@v1
                with:
                    node-version: ${{ matrix.node-version }}
            - name: install modules
                run: yarn install --frozen-lockfile
            - name: build production project
                run: yarn build:prod
                if: always()
            - name: linting typescript
                run: yarn lint:ts
                if: always()
            - name: linting css
                run: yarn lint:scss
                if: always()
            - name: unit testing
                run: yarn test:unit
                if: always()
            - name: build storybook
                run: yarn storybook:build
            # Use it, if need to update reference loki screens with errors
            - name: Update Loki reference files
                run: yarn loki update --reactUri="file:./storybook-static"
            - name: screenshot testing
                run: yarn test:ui:ci
</pre>

У нас стало появляться много скриптов (линтеры, сборка, разные виды тестирования, сборка сторибука).
Запускать это вручную становится неудобно. Хочется автоматизировать процесс запуска этих скриптов.
Будем использовать Github-actions для настройки CI/CD.

CI/CD переводится как непрерывная интеграция и непрерывное развертывание (доставка).
Это конвейер, который позволяет автоматизировать рутинные процессы
(сборка приложения, прогон тестов, прогон линтеров, проверка типизации (CI) / деплой, релиз (CD) и т.д.).

Сначала CI.
CI процессы обычно запускаются скриптами, описанными в package.json.
Нужна автоматизация чтобы:

- Не делегировать эту ответственность (ручной запуск скриптов) на разработчика и нивелировать человеческий фактор
- Не загружать разработчика лишней работой (т.к. она стоит дорого)
- Повышение надежности приложения в целом
  Хотелось бы, чтобы при создании pull request (PR) и при последующих коммитах в ветку
  автоматически запускались бы все эти процессы (сборка, тесты, линтеры и пр. проверки (CI), которые необходимы в нашем приложении)
  и чтобы мы не могли вмерджить ветку в main до тех пор, пока мы не убедились, что все эти процессы отработали без ошибок.
  И если хотябы 1 из таких проверок упала, то нам нужно запретить merge в основную (main) ветку, чтобы не сломать код.

Настройка:
Примеры для настройки можно брать из guthub, либо сделать запрос github actions frontend, chat-gpt и т.д.
Создали папку .github в корне приложения, а внутри неё папку workflows (рабочий процесс).
Далее нужно внутри этой папки создать файл с расширением .yml (название любое).
Скопируем пример кода для файла из https://docs.github.com/ru/actions/writing-workflows/quickstart
Далее отдельным коммитов нужно запушить yml файл в github (commit m: "add main pipeline github actions")
Потом заходим в github репозиторий / actions.
Там будет этот workflow, в который можно провалиться и посмотреть на процессы, описанные в yml файле.
В начале скрипты будут в виде echo (т.е. логи текстов, моки для проверки).
Там могут быть любые сложные скрипты, например npm run build.
В файле main.yml поменяли name: linting, testing, building.
В начале укажем что все проверки будут запускаться на push в ветку master и при создании pull_request.
Далее нужно описать jobs. Удаляем старую.
Создадим новую с названием pipeline (можно называть как угодно).
В поле runs-on указывается ОС, в которой будет запускаться job.
Затем необходимо указать версию NodeJS, которая будет использоваться
Для работы с фронтом, нужно всегда устанавливать в первую очень NodeJS, чтобы код мог работать.
В steps указаны наши скрипты
Там (после стэпов по установке NodeJS) первым делом нужно установить node_modules.
Далее можно например запускать сборку
Потом сделаем запуск скрипта линтера для ts, потом линтер для css, потом все виды тестов, потом сборку storybook.
Далее пушим в репозиторий, наблюдаем как выполняются jobs. (появится желтая точка в репозитории, из неё перейти быстрее).
Bundle-analyser отключил, т.к. он не дает завершиться процессу сборки.
В документации loki есть описание интеграции unit тестов в CI pipeline (https://loki.js.org/continuous-integration.html).
В начале нужно сделать сборку storybook, потом на основании этой сборки (storybook-static) можно делать скриншоты.
Т.е. запускать его в CI pipeline не обязательно. Добавили сборку в gitignore.
И добавили скрипт test:ui:ci для loki, который будет запускаться после сборки storybook и снимать с неё скриншоты.
Не забываем добавить скрипты в yml файл

Далее когда CI закончен без ошибок, мы мерджим код в main ветку, затем идёт сборка приложения (если это требуется).
И дальнейшая публикация этой сборки на тестовое или прод окружение (CD).
Т.е. CI/CD касается как ежедневных процессов (для тестирования), так и еженедельных (смотря какой спринт, релиз на прод).
Так же можно отдельно ознакомиться с темой CI/CD тут https://www.youtube.com/watch?v=ANj7qUgzNq4

Следующие тесты не запустились, т.к. конфиг был настроен так, что jobs выполняются последовательно.
Если одна из них падает, то следующие не запускаются. Нужно в step добавить проверку if: always(), чтобы они запускались в любом случае.
Сделали это для всего, что может идти последовательно (билд, линтеры, тесты, кроме инсталяции пакетов в начале).
