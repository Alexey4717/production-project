# Husky и прекоммит-хуки

**Husky** — это инструмент для запуска скриптов перед определёнными Git-событиями, такими как `commit`, `push` и другие. Это позволяет запускать автоматические проверки до того, как изменения попадут в репозиторий, аналогично тому, как работают CI-инструменты (например, GitHub Actions), но **локально**.

---

## Установка и инициализация Husky

Установите Husky:

```bash
npm install --save-dev husky
```

Инициализируйте его:

```bash
npx husky init
```

После этого:

- В package.json будет добавлен скрипт prepare, который автоматически включает хуки при установке зависимостей.
- В корне проекта появится папка .husky/.
- Внутри неё будет создан пример хука — файл .husky/pre-commit.

----

## Как работает pre-commit

pre-commit — это один из хуков, который срабатывает перед коммитом. В этом файле можно запускать любые команды:

Пример:

```bash
#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

npm run lint
```

Обычно здесь запускают только лёгкие и быстрые проверки, такие как линтеры.
Тяжёлые задачи (сборка, тесты, сторибук) — слишком затратны и могут замедлить разработку.

----

## Почему не запускать всё подряд?

Представьте: вы изменили 2 строки в одном файле, запускаете git commit, а перед этим:

- Прогоняются все тесты.
- Собирается весь проект.
- Генерируется сторибук.

Это может занять несколько минут, раздражать разработчиков и замедлять процесс разработки.
Лучше выносить такие проверки в CI.

Однако, в рамках учебного проекта (или в проектах с ограничениями на использование GitHub Actions), 
можно настроить полные проверки прямо в прекоммит-хуке.

Это позволит:

- Проверять код до пуша в репозиторий.
- Не тратить бесплатные минуты GitHub Actions.
- Гарантировать, что в git попадёт только валидный код.
- Для корректной работы визуальных тестов, основанных на Storybook, потребуется локальный запуск сторибука.

----

## lint-staged — запуск проверок только на изменённые файлы

По умолчанию, линтер может запускаться на весь проект. Это долго.

lint-staged позволяет запускать линтер и другие инструменты только на тех файлах, которые были изменены и попадают в коммит.

### Установка lint-staged

```bash
npm install --save-dev lint-staged
```

### Настройка lint-staged

```bash
"lint-staged": {
  "*.{ts,tsx}": [
    "eslint --fix",
    "prettier --write"
  ],
  "*.{css,scss}": [
    "stylelint --fix"
  ]
}
```

Или в отдельном файле .lintstagedrc:

```bash
{
  "*.{ts,tsx}": ["eslint --fix", "prettier --write"],
  "*.{css,scss}": ["stylelint --fix"]
}
```

### Откройте .husky/pre-commit и замените содержимое:

```bash
#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

npx lint-staged
```

Теперь при коммите будут запускаться только нужные проверки на изменённые файлы. Это быстрее и удобнее для разработчиков.

----

## Пример полного рабочего пайплайна

```bash
{
  "scripts": {
    "lint": "eslint 'src/**/*.{ts,tsx}'",
    "prepare": "husky install"
  },
  "lint-staged": {
    "*.{ts,tsx}": [
      "eslint --fix"
    ]
  },
  "devDependencies": {
    "husky": "^9.0.0",
    "lint-staged": "^15.0.0",
    "eslint": "^8.0.0"
  }
}
```

----

## Советы

- Запускайте только быстрые проверки в прекоммитах, чтобы не мешать фокусированному процессу разработки.
- Используйте Husky в связке с lint-staged, чтобы не линтить весь проект.
- CI-пайплайн (GitHub Actions) всё равно должен существовать как "вторая линия защиты".
- Проверки на коммите — это ранняя обратная связь, что делает разработку стабильнее.

----

## Рекомендации по использованию

1. Что включать в pre-commit:

- Быстрые проверки (линтеры, форматирование)
- Unit-тесты для измененных файлов
- Проверки типов (TypeScript)

2. Что НЕ включать:

- Долгие процессы (E2E тесты, сборка Storybook)
- Проверки, которые уже есть в CI/CD

Оптимальный набор:

```bash
"lint-staged": {
  "*.{js,jsx,ts,tsx}": [
    "eslint --fix",
    "prettier --write",
    "jest --bail --findRelatedTests"
  ],
  "*.{css,scss}": [
    "stylelint --fix"
  ]
}
```

----

## Дополнительные возможности

### Добавление других хуков

Пример добавления pre-push хука:

```bash
npx husky add .husky/pre-push "npm run test:all"
```

### Пропуск хуков

Если нужно временно пропустить хуки:

```bash
git commit --no-verify -m "Сообщение коммита"
```

### Отладка

Если хук не работает:

1. Проверьте права на выполнение файла:

```bash
chmod +x .husky/* 
```

2. Проверьте логи:

```bash
git commit -m "Test" --verbose
```

## Полезные ссылки

- [Документация Husky](https://typicode.github.io/husky/)
- [lint-staged GitHub](https://github.com/lint-staged/lint-staged)
- [Git Hooks (официально)](https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks)
