## Screenshot testing (loki)
Есть платные и бесплатные библиотеки. Тут используется Loki.
Инициализация - Сначала установка пакета loki в devDep, потом npx loki init --config <путь до конфига storybook>
В package.json добавится конфигурация loki
Скрины будут сниматься на ноуте в хроме и iphone на хроме (судя по конфигам)
Меняем там в target с docker на app (Если работа в linux или macOS)
На винде могут быть проблемы с запуском (если так, то нужно вернуть target docker и запустить приложение docker на ПК)
Мне так же пришлось поднять версию loki до 0.29.0, т.к. под капотом 0.28.0 использовала 16 версию react и были конфликты
Для работы с loki сначала нужно запустить storybook
Для скриншотного тестирования необходимо выполнить команду npx loki test
После успешного выполнения тестов появится папка .loki со скриншотами в виде png разных компонентов в разных состояниях
При изменении чего-то в компонентах и прогоне повторных тестов, часть тестов упадет, т.к. они будут сравниваться со старыми скриншотами
в папке difference.
При наличии различий в difference можно запустить скрипт report, чтоб сгенерить новые файлы (json и html), и там более наглядно посмотреть различия.
Регрессионное тестирование - когда мы убеждаемся, что новый функционал не сломал старый.
Так же скриншотные тесты помогают определить, что в сторибуке что-то не так, т.к. они снимаются на основании сторибука.
Скриншоты отправляются в удаленный репозиторий.
Добавили скрипт test:ui для скриншотных тестов и test:ui:ok для одобрения скриншотов (т.е. когда loki отловил ожидаемые изменения,
изменения которые осознанно сделаны и мы их подтверждаем)
Скриншотные тесты используют разные движки (по скорости) - https://loki.js.org/configuration.html.
default - pixelmatch движок.

Когда компоненты будут нагружены, смотреть скриншоты будет тяжело.
Есть инструмент reg-cli для сравнения скриншотов. Добавили пакет в devDep.

Добавили скрипты в package.json.
test:ui:json - генерит файл .loki/report.json, но он не удобен для чтения.
test:ui:html - генерит html отчет (используя json) с интерфейсом, который удобен для чтения и сравнения скриншотов.
test:ui:report - объединяет эти 2 скрипта. Если скриншотные тесты ломаются, нужно запускать report и смотреть что там.
Можно каждый скриншот открыть и посмотреть наглядно, какие произошли изменения.
Так же нужно указать в .gitignore эти сгенеренные отчеты, т.к. там они не нужны.
Подтвердили скрины (test:ui:ok скриптом), чтобы прошли CI.

Падали скриншотные тесты, т.к. в сторибуке не отображаются ошибки неверных кредов для авторизации.
Т.к. при инициализации не определяется асинхронный редьюсер.
Добавили в StoreProvider передачу asyncReducers, которые передаются в createReduxStore.

Генерация отчета для скриншотных тестов в CI. Github pages and jobs.
От локального запуска скриншотных тестов особого смысла нет, потому что в какой-то момент они начнут запускаться и прогоняться слишком долго.
Т.к. компонентов становится много, стори-кейсов много, ссответственно и скриншотов много. И на их проверки нужно время.
Поэтому эти тесты лучше прогонять в CI pipeline перед тем как мёрджить код в ветку (main/master).
В файле .github/workflows/main.yml лучше изменить run: yarn install на npm install ci (для yarn install --frozen-lockfile).
Это специальная команда, которая предназначена для более быстрой установки зависимостей именно в CI.
Там не создаётся новый package.lock файл и используется уже существующий.
Если посмотреть в CI pipelines в job`e со скриншотными тестами, можно увидеть ошибки скринов, но не понятно из-за чего они.
Хотелось бы чтобы прям в CI можно было посмотреть отчёт.
В amin.yml закомментили старый функционал и добавили новый.
Там есть доступ с пермишенами. Теперь 2 jobs, она для проверок, которая не требует сборки (линтинг, unit тестирование).
А другая для тех проверок, которые требуют сборки (скриншотное тестирование, генерация html репорта...).
Т.е. эти 2 jobs будут запускаться параллельно и не будут влиять друг на друга.
Там указываем что папка .loki она будет со статикой, которую необходимо раздать (report). Чуть позже будем раздавать репорт для unit тестов.
Для того чтобы github pages работали, нужно в настройках проекта (settings/pages) их включить.
Github pages работают либо только для платных (коммерческих) проектов, либо для публичных проектов (мы выбрали публичный).
Source выберем как github-actions.
В yml файле в jobs можно указывать зависимость одной джобы от другой (указав needs поле и передав массив названий job от которых она зависит).
Если провалиться в ошибки в CI по скриншотам, то там будет ссылка на пейджу на статический репорт файл (обычно поиск по index.html, но у нас report.html).
TODO В сторке сторибука нужно будет поправить настройку для FileLoader и сделать её одинаковой
UPD: мне также пришлось в файле main.yml подымать версии некоторых artifact до 3 или 4 (т.к. старые 1-2 были deprecated).

Отчет для юнит тестов в CI.
Перенесли процесс unit testing в джобу build-and-ui-testing перед генерация html репортов
Поменяли path на reports, но отчеты из папки .loki нужно переместить в папку reports (отдельный процесс move loki).
Т.е. на уровне CI будет переноситься директория loki в reports и потом читаться отчёты оттуда.
Потом необходимо сделать index.html файл и положить его в корень reports (как связующее звено) со ссылками на репорты скриншотных и юнит тестов.
Можно её приукрасить и сделать поприятнее при необходимости.
Можно по каждому коммиту при генерации отчета генерить хэш в урле, чтоб был униклаьный путь до html отчета.
